{%- liquid
  # Search Overlay Section
  # Desktop (>700px): 528px width overlay positioned at x:10, y:10
  # Tablet (<=700px): Full screen overlay (700px width)
  # Mobile (<=412px): Full screen overlay (412px width)

  # Get 3 recent blog posts for "Discover More" section
  assign recent_blogs = blogs[section.settings.blog_handle].articles | default: blank
  assign blog_limit = 3
-%}

{{ 'section-search-overlay.css' | asset_url | stylesheet_tag }}

{%- comment -%} Search Overlay - Hidden by default, shown via Alpine.js {%- endcomment -%}
<div
  x-data="searchOverlay()"
  x-ref="backdrop"
  @click.self="closeOverlay()"
  class="search-overlay__backdrop"
  style="display: none;"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-overlay-title"
>
  <div
    x-ref="overlayContainer"
    class="search-overlay__container"
    @click.stop
  >
    {%- comment -%} Search Bar {%- endcomment -%}
    <div class="search-overlay__search-bar">
      <div class="search-overlay__search-content">
        <div class="search-overlay__search-left">
          {{ 'icon-header-search.svg' | inline_asset_content | replace: 'currentColor', 'var(--color-text-secondary)' }}
          <input
            x-model="searchQuery"
            @input.debounce.300ms="handleSearch()"
            @keydown.enter="handleEnterKey()"
            type="text"
            placeholder="SEARCH"
            class="search-overlay__search-input"
            aria-label="Search products"
            autocomplete="off"
          >
        </div>
        <button
          @click="closeOverlay()"
          class="search-overlay__close-button"
          aria-label="Close search"
        >
          {{ 'icon-close-button.svg' | inline_asset_content }}
        </button>
      </div>
      <div class="search-overlay__search-divider">&nbsp;</div>
    </div>

    {%- comment -%} Content Area {%- endcomment -%}
    <div class="search-overlay__content">
      {%- comment -%} Loading State: Skeleton Loaders {%- endcomment -%}
      <template x-if="isSearching">
        <div class="search-overlay__section">
          <h2 class="search-overlay__section-title">PRODUCTS & COLLECTIONS</h2>
          <div class="search-overlay__products">
            {% render 'search-skeleton-product' %}
            {% render 'search-skeleton-product' %}
            {% render 'search-skeleton-product' %}
          </div>
        </div>
      </template>

      <template x-if="isSearching">
        <div class="search-overlay__section search-overlay__section--blogs">
          <h2 class="search-overlay__section-title">HOUSE OF BASSFACE</h2>
          <div class="search-overlay__blogs">
            {% render 'search-skeleton-blog' %}
            {% render 'search-skeleton-blog' %}
            {% render 'search-skeleton-blog' %}
          </div>
        </div>
      </template>

      {%- comment -%} Search Results View: Products & Collections {%- endcomment -%}
      <template x-if="hasSearchResults && !isSearching">
        <div class="search-overlay__section">
          <h2 class="search-overlay__section-title">PRODUCTS & COLLECTIONS</h2>
          <div class="search-overlay__products">
            <template x-for="(product, index) in searchResults.products.slice(0, 3)" :key="product.id">
              <a
                :href="product.url"
                class="search-overlay__product-card"
                :aria-label="'View ' + product.title"
              >
                <div class="search-overlay__product-image">
                  <img
                    :src="product.featured_image"
                    :alt="product.title"
                    width="80"
                    height="80"
                    loading="lazy"
                  >
                </div>
                <div class="search-overlay__product-info">
                  <p class="search-overlay__product-category" x-text="product.product_type"></p>
                  <p class="search-overlay__product-title" x-text="product.title"></p>
                </div>
              </a>
            </template>
            <template x-if="searchResults.products.length === 0">
              <div class="search-overlay__fallback">
                <p class="search-overlay__fallback-text">No products found</p>
              </div>
            </template>
          </div>

          {%- comment -%} MORE PRODUCTS Button {%- endcomment -%}
          <template x-if="searchResults.products.length > 3">
            <button
              x-ref="moreProductsBtn"
              @click="navigateToSearch('products')"
              @mouseenter="handleButtonHover($event, $refs.moreProductsBtn)"
              @mouseleave="handleButtonLeave($refs.moreProductsBtn)"
              class="search-overlay__button"
              :class="{ 'search-overlay__button--loading': isNavigating }"
              :disabled="isNavigating"
            >
              <span class="search-overlay__button-fill"></span>
              <span class="search-overlay__button-text" x-text="isNavigating ? 'Navigating...' : 'MORE PRODUCTS'"></span>
            </button>
          </template>
        </div>
      </template>

      {%- comment -%} Search Results View: Blogs {%- endcomment -%}
      <template x-if="hasSearchResults && searchResults.articles.length > 0">
        <div class="search-overlay__section search-overlay__section--blogs">
          <h2 class="search-overlay__section-title">HOUSE OF BASSFACE</h2>
          <div class="search-overlay__blogs">
            <template x-for="(article, index) in searchResults.articles.slice(0, 3)" :key="article.id">
              <a
                :href="article.url"
                class="search-overlay__blog-link"
                :aria-label="'Read ' + article.title"
              >
                <span class="search-overlay__blog-title" x-text="article.title.toUpperCase()"></span>
                <span class="search-overlay__blog-arrow">
                  {{ 'icon-arrow-right.svg' | inline_asset_content }}
                </span>
              </a>
            </template>
          </div>

          {%- comment -%} VIEW ALL RESULTS Button {%- endcomment -%}
          <button
            x-ref="viewAllBtn"
            @click="navigateToSearch('all')"
            @mouseenter="handleButtonHover($event, $refs.viewAllBtn)"
            @mouseleave="handleButtonLeave($refs.viewAllBtn)"
            class="search-overlay__button"
            :class="{ 'search-overlay__button--loading': isNavigating }"
            :disabled="isNavigating"
          >
            <span class="search-overlay__button-fill"></span>
            <span class="search-overlay__button-text" x-text="isNavigating ? 'Navigating...' : 'VIEW ALL RESULTS'"></span>
          </button>
        </div>
      </template>

      {%- comment -%} Default View: Currently Trending Section {%- endcomment -%}
      <div x-show="!hasSearchResults && !isSearching" class="search-overlay__section">
        <h2 id="search-overlay-title" class="search-overlay__section-title">
          {{ section.settings.trending_title }}
        </h2>
        <div class="search-overlay__products">
          {%- liquid
            assign has_products = false
            for i in (1..3)
              assign product_setting = 'product_' | append: i
              assign product = all_products[section.settings[product_setting]]
              if product != blank
                assign has_products = true
                break
              endif
            endfor
          -%}

          {%- if has_products -%}
            {%- for i in (1..3) -%}
              {%- assign product_setting = 'product_' | append: i -%}
              {%- assign product = all_products[section.settings[product_setting]] -%}
              {%- if product != blank -%}
                <a
                  href="{{ product.url }}"
                  class="search-overlay__product-card"
                  aria-label="View {{ product.title }}"
                >
                  <div class="search-overlay__product-image">
                    {%- if product.featured_image -%}
                      <img
                        src="{{ product.featured_image | image_url: width: 160 }}"
                        srcset="{{ product.featured_image | image_url: width: 80 }} 80w,
                                {{ product.featured_image | image_url: width: 160 }} 160w,
                                {{ product.featured_image | image_url: width: 200 }} 200w"
                        sizes="(min-width: 700px) 80px, 100px"
                        alt="{{ product.featured_image.alt | escape }}"
                        width="80"
                        height="80"
                        loading="lazy"
                      >
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag: 'search-overlay__product-placeholder' }}
                    {%- endif -%}
                  </div>
                  <div class="search-overlay__product-info">
                    {%- if product.type != blank -%}
                      <p class="search-overlay__product-category">{{ product.type }}</p>
                    {%- endif -%}
                    <p class="search-overlay__product-title">{{ product.title }}</p>
                  </div>
                </a>
              {%- endif -%}
            {%- endfor -%}
          {%- else -%}
            {%- comment -%} Fallback when no products are selected {%- endcomment -%}
            <div class="search-overlay__fallback">
              <p class="search-overlay__fallback-text">Not available, come back later</p>
            </div>
          {%- endif -%}
        </div>
      </div>

      {%- comment -%} Default View: Discover More Section (Recent Blogs) {%- endcomment -%}
      <div x-show="!hasSearchResults && !isSearching" class="search-overlay__section search-overlay__section--blogs">
        <h2 class="search-overlay__section-title">
          {{ section.settings.discover_title }}
        </h2>
        <div class="search-overlay__blogs">
          {%- if recent_blogs != blank and recent_blogs.size > 0 -%}
            {%- for article in recent_blogs limit: blog_limit -%}
              <a
                href="{{ article.url }}"
                class="search-overlay__blog-link"
                aria-label="Read {{ article.title }}"
              >
                <span class="search-overlay__blog-title">{{ article.title | upcase }}</span>
                <span class="search-overlay__blog-arrow">
                  {{ 'icon-arrow-right.svg' | inline_asset_content }}
                </span>
              </a>
            {%- endfor -%}
          {%- else -%}
            {%- comment -%} Fallback if no blog is configured or no articles available {%- endcomment -%}
            <div class="search-overlay__fallback">
              <p class="search-overlay__fallback-text">Not available, come back later</p>
            </div>
          {%- endif -%}
        </div>
      </div>
    </div>
  </div>
</div>

<script src="{{ 'section-search-overlay.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Search Overlay",
  "class": "section-search-overlay",
  "settings": [
    {
      "type": "header",
      "content": "Currently Trending Section"
    },
    {
      "type": "text",
      "id": "trending_title",
      "label": "Section Title",
      "default": "CURRENTLY TRENDING"
    },
    {
      "type": "product",
      "id": "product_1",
      "label": "Product 1"
    },
    {
      "type": "product",
      "id": "product_2",
      "label": "Product 2"
    },
    {
      "type": "product",
      "id": "product_3",
      "label": "Product 3"
    },
    {
      "type": "header",
      "content": "Discover More Section"
    },
    {
      "type": "text",
      "id": "discover_title",
      "label": "Section Title",
      "default": "DISCOVER MORE"
    },
    {
      "type": "blog",
      "id": "blog_handle",
      "label": "Blog",
      "info": "Select the blog to display recent posts from"
    }
  ],
  "presets": [
    {
      "name": "Search Overlay"
    }
  ]
}
{% endschema %}
